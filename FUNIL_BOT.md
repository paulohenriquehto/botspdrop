# ๐ FUNIL DO BOT - Fluxo Interno (Mensagem โ Resposta)

## Visรฃo Geral

Este documento mostra o fluxo completo de como uma mensagem do WhatsApp รฉ recebida, processada e respondida pelo bot.

---

## ๐ FLUXO COMPLETO

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MENSAGEM DO WHATSAPP                         โ
โ            "Olรก, quero saber sobre dropshipping"                โ
โ                   (5511999999999@c.us)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 1: RECEPรรO (WhatsApp Web.js โ main.py:113)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  POST /webhook                      โ
        โ  โข Payload JSON recebido            โ
        โ  โข from: 5511999999999@c.us         โ
        โ  โข body: "Olรก, quero saber..."      โ
        โ  โข timestamp: 1234567890            โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                    โโโโโโโโโโโโโโโโโ
                    โ ร GRUPO?      โ
                    โโโโโโโโโโโโโโโโโ
                      โ          โ
                  SIM              NรO
                   โ                โ
            [IGNORAR]         [CONTINUAR]
                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 2: BUFFER (main.py:45) - Aguardar 13 segundos           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Sistema de Buffer:                 โ
        โ  โข Junta mensagens fracionadas      โ
        โ  โข Aguarda 13s sem nova mensagem    โ
        โ  โข Cancela timer se chegar nova msg โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  Mensagem Unificada:                โ
        โ  "Olรก, quero saber sobre            โ
        โ   dropshipping"                     โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 3: NORMALIZAR TELEFONE (customer_manager.py:30)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  normalize_phone()                  โ
        โ  5511999999999@c.us โ 5511999999999 โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 4: BUSCAR/CRIAR CLIENTE (customer_manager.py:45)        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  get_or_create_customer()           โ
        โ  โข Busca: SELECT * FROM customers   โ
        โ    WHERE phone = '5511999999999'    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ              โ
            ENCONTROU?              NรO EXISTE
                โ                       โ
        โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ
        โ customer_id  โ        โ INSERT INTO  โ
        โ      = 1     โ        โ customers    โ
        โ (Paulo)      โ        โ RETURNING id โ
        โโโโโโโโโโโโโโโโ        โโโโโโโโโโโโโโโโ
                      โ              โ
                         customer_id
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 5: RECUPERAR CONTEXTO (customer_manager.py:99)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  get_customer_info()                โ
        โ  โข JOIN customers + context         โ
        โ  โข JOIN user_preferences            โ
        โ  โข Retorna: nome, email, nicho,     โ
        โ    conversas anteriores             โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 6: CRIAR SESSION_ID (main.py:266)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  session_id = whatsapp_5511999999999โ
        โ  โข Busca ou cria em sessions        โ
        โ  โข INSERT se nรฃo existir            โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 7: CONSTRUIR MENSAGEM COM CONTEXTO (main.py:259)        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  build_context_message()            โ
        โ                                     โ
        โ  [CONTEXTO: customer_id=1]          โ
        โ  Olรก, quero saber sobre dropshippingโ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 8: BUSCAR HISTรRICO (tools/memory_tools.py:83)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  get_conversation_history()         โ
        โ  โข SELECT รบltimas 10 conversas      โ
        โ  โข FROM conversation_history        โ
        โ  โข WHERE customer_id = 1            โ
        โ  โข ORDER BY timestamp DESC          โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  HISTรRICO RECUPERADO:              โ
        โ  1. "Quero o teste" โ "Ok..."       โ
        โ  2. "Posso testar?" โ "Sim..."      โ
        โ  3. "O semestral..." โ "รtima..."   โ
        โ  ... (7 conversas anteriores)       โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 9: PROCESSAR COM AGENTE (agente_suporte.py)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  support_agent.run()                โ
        โ  โข Recebe: mensagem + session_id    โ
        โ  โข Tem acesso a memory_tools        โ
        โ  โข Usa histรณrico para contexto      โ
        โ  โข Processa com GPT-4.1 mini        โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  AGENTE RACIOCINA:                  โ
        โ  "Paulo jรก conhece a plataforma,    โ
        โ   jรก estรก em teste, jรก sabe dos     โ
        โ   planos... Vou dar mais detalhes   โ
        โ   sobre dropshipping"               โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  RESPOSTA GERADA:                   โ
        โ  "Oi Paulo! ๐ Dropshipping รฉ um    โ
        โ   modelo onde vocรช vende produtos   โ
        โ   sem estoque... Como estรก sendo    โ
        โ   seu teste atรฉ agora?"             โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 10: SALVAR CONVERSA (customer_manager.py:194)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  save_conversation()                โ
        โ  INSERT INTO conversation_history   โ
        โ  โข session_id: whatsapp_5511...     โ
        โ  โข customer_id: 1                   โ
        โ  โข user_message: "Olรก, quero..."    โ
        โ  โข agent_response: "Oi Paulo!..."   โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 11: DIVIDIR MENSAGEM (main.py:153)                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  send_message_in_parts()            โ
        โ  โข Divide por parรกgrafos            โ
        โ  โข Mรกximo 200 caracteres por parte  โ
        โ  โข Delay 3-6s entre envios          โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  MENSAGENS SEPARADAS:               โ
        โ  1. "Oi Paulo! ๐"                  โ
        โ     โฑ๏ธ Delay 3s                     โ
        โ  2. "Dropshipping รฉ um modelo..."   โ
        โ     โฑ๏ธ Delay 4s                     โ
        โ  3. "Como estรก sendo seu teste?"    โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ETAPA 12: ENVIAR WHATSAPP (whatsapp_integration.py)           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  whatsapp_client.send_text()        โ
        โ  โข POST para WhatsApp Web.js        โ
        โ  โข to: 5511999999999@c.us           โ
        โ  โข body: "Oi Paulo! ๐"             โ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              MENSAGEM ENTREGUE AO USUรRIO โ                    โ
โ                     (WhatsApp Paulo)                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โฑ๏ธ TEMPO TOTAL (Mensagem โ Resposta)

```
1. Recepรงรฃo webhook:           0.1s
2. Buffer (aguardar):          13.0s  โ MAIOR DELAY
3. Buscar/criar cliente:        0.2s
4. Recuperar contexto:          0.3s
5. Criar session_id:            0.1s
6. Buscar histรณrico:            0.2s
7. Processar com Agente:        2-5s  โ PROCESSAMENTO GPT
8. Salvar conversa:             0.2s
9. Dividir mensagem:            0.1s
10. Enviar (3 partes):          9s    โ 3s + delay + 3s + delay + 3s
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
TOTAL: ~25-28 segundos
```

---

## ๐ RESUMO DAS ETAPAS

1. **Recepรงรฃo**: WhatsApp Web.js envia webhook
2. **Buffer**: Aguarda 13s para juntar mensagens fracionadas
3. **Normalizaรงรฃo**: Remove @c.us do telefone
4. **Cliente**: Busca ou cria no banco de dados
5. **Contexto**: Recupera informaรงรตes do cliente
6. **Sessรฃo**: Cria/busca session_id รบnico
7. **Mensagem**: Adiciona contexto interno
8. **Histรณrico**: Busca รบltimas 10 conversas
9. **Agente**: Processa com GPT-4.1 mini
10. **Salvar**: Grava conversa no banco
11. **Dividir**: Separa resposta em partes menores
12. **Enviar**: Envia ao WhatsApp com delays

---

## ๐ PONTOS-CHAVE

- โ **Telefone = Identidade รบnica** do cliente
- โ **session_id** baseado no nรบmero normalizado
- โ **Histรณrico completo** recuperado a cada mensagem
- โ **Contexto mantido** entre conversas
- โ **Buffer de 13s** para mensagens fracionadas
- โ **Respostas divididas** para parecer humano
- โ **Delays entre envios** (3-6s)

---

## ๐ Arquivos Envolvidos

- `main.py` - Webhook e orquestraรงรฃo principal
- `customer_manager.py` - Gestรฃo de clientes e contexto
- `tools/memory_tools.py` - Ferramentas de memรณria/histรณrico
- `agentes/agente_suporte.py` - Agente de IA
- `whatsapp_integration.py` - Integraรงรฃo WhatsApp

---

**Data de criaรงรฃo**: 19/11/2025
**Versรฃo**: 1.0
