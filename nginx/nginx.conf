# Configuração Nginx - Gateway de Segurança SPDrop

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Rate limiting - proteção contra spam e DDoS
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=whatsapp_limit:10m rate=5r/s;
    limit_req_zone $binary_remote_addr zone=general_limit:10m rate=20r/s;

    # Upstream para API Admin
    upstream api {
        server api:8000;
    }

    # Upstream para WhatsApp Service
    upstream whatsapp {
        server whatsapp:3000;
    }

    server {
        listen 80;
        server_name localhost;

        # Logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # Segurança: Headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        # Limite geral de tamanho de upload (para imagens/áudios)
        client_max_body_size 10M;

        # ========================================
        # API ADMIN - Rotas protegidas
        # ========================================
        location /api/ {
            # Rate limiting
            limit_req zone=api_limit burst=20 nodelay;

            # Proxy para API interna
            proxy_pass http://api;

            # Headers para preservar informações do cliente
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # CORS headers (Nginx adiciona, API também tem)
            add_header Access-Control-Allow-Origin "http://localhost" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
            add_header Access-Control-Allow-Credentials "true" always;

            # OPTIONS para CORS preflight
            if ($request_method = 'OPTIONS') {
                return 204;
            }
        }

        # ========================================
        # WHATSAPP QR CODE - Interface visual
        # ========================================
        location /whatsapp/ {
            # Rate limiting mais restrito
            limit_req zone=whatsapp_limit burst=10 nodelay;

            # Proxy para WhatsApp service
            proxy_pass http://whatsapp/;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts maiores (QR Code pode demorar)
            proxy_connect_timeout 120s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
        }

        # ========================================
        # BLOQUEIOS DE SEGURANÇA
        # ========================================

        # BLOQUEAR webhook (apenas WhatsApp service interno pode chamar)
        location /webhook {
            deny all;
            return 403 "Acesso negado";
        }

        # BLOQUEAR endpoints internos do WhatsApp service
        location /send {
            deny all;
            return 403 "Acesso negado";
        }

        location /logout {
            deny all;
            return 403 "Acesso negado";
        }

        # ========================================
        # FRONTEND (React Dashboard)
        # ========================================
        location / {
            # Rate limiting geral
            limit_req zone=general_limit burst=50 nodelay;

            # Servir arquivos estáticos do frontend
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }

        # ========================================
        # HEALTH CHECK PÚBLICO
        # ========================================
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # ========================================
        # DOCUMENTAÇÃO SWAGGER (apenas em dev)
        # ========================================
        location /docs {
            proxy_pass http://api/docs;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://api/redoc;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://api/openapi.json;
            proxy_set_header Host $host;
        }
    }
}
